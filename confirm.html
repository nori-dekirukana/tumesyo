<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>帰参届（確認）</title>
<style>
  body{font-family:system-ui,sans-serif; padding:16px; background:#f7f7f7;}
  h1{font-size:2rem; margin:8px 0 12px; text-align:center;}
  #cap{background:#fff; padding:16px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.06); max-width:900px; margin:0 auto;}
  table{width:100%; border-collapse:collapse; margin-top:8px; font-size:16px;}
  th,td{border:1px solid #bbb; padding:8px; text-align:left;}
  .row-actions{display:flex; gap:12px; flex-wrap:wrap; margin-top:14px; justify-content:center;}
  /* オーバーレイ（最終手段） */
  #overlay{position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:9999;}
  #overlay .box{background:#fff; padding:10px; max-width:96vw; max-height:92vh; border-radius:8px;}
  #overlay img{max-width:100%; height:auto; display:block;}
  #overlay .msg{font-size:.95rem; color:#333; margin-top:6px;}
  #overlay .close{margin-top:8px; width:100%;}
</style>
</head>
<body>
  <div id="cap">
    <h1>帰参届（確認）</h1>
    <div id="preview"></div>
  </div>
  <div class="row-actions">
    <button id="shareImage">画像で送る（スクショ）</button>
    <button id="backEdit">編集に戻る</button>
  </div>
  <!-- 画像オーバーレイ -->
  <div id="overlay">
    <div class="box">
      <img id="shotImg" alt="帰参届の画像">
      <div class="msg">画像を長押しして「共有」または「写真に保存」を選んでください。</div>
      <button class="close" id="closeOverlay">閉じる</button>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
  const SESSION_KEY = 'kisanFormV2';

  const data = JSON.parse(sessionStorage.getItem(SESSION_KEY) || 'null');
  if (!data){ location.href='./index.html'; }
  const cap = document.getElementById('cap');
  const preview = document.getElementById('preview');

  const WEEKS = ['日','月','火','水','木','金','土'];
  const fmtMD = (ymd)=>{ if(!ymd) return ''; const [y,m,d]=ymd.split('-'); return `${Number(m)}/${Number(d)}`; };
  const fmtMDw = (ymd)=> {
    if(!ymd) return '';
    const dt=new Date(ymd+'T00:00:00'); return `${fmtMD(ymd)}(${WEEKS[dt.getDay()]})`;
  };
  function esc(s=''){return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m] ));}

  function buildDaysTableHTML(days){
    return `
      <table>
        <thead><tr><th>日付(曜)</th><th>朝食</th><th>昼食</th><th>夕食</th><th>宿泊</th></tr></thead>
        <tbody>
          ${days.map(d=>`<tr>
            <td>${esc(fmtMDw(d.date))}</td><td>${d.breakfast||0}</td><td>${d.lunch||0}</td><td>${d.dinner||0}</td><td>${d.stay||0}</td>
          </tr>`).join('')}
        </tbody>
      </table>
    `;
  }
  function buildPreview(d){
    const total=(d.adult||0)+(d.child||0)+(d.infant||0);
    const transportRow = d.transport.type === '独自' && d.transport.detail === '乗用車'
      ? `${esc(d.transport.type)}（${esc(d.transport.detail)}）／ 台数 ${d.carCount||0}台`
      : `${esc(d.transport.type)}（${esc(d.transport.detail)}）`;
    return `
      <table>
        <tr><th>教会名（団体名）</th><td>${esc(d.kyokai)}</td></tr>
        <tr><th>帰参者名（代表）</th><td>${esc(d.kisan)}</td></tr>
        <tr><th>人数</th><td>大人${d.adult||0} 子供${d.child||0} 乳児${d.infant||0}（計${total}）</td></tr>
        <tr><th>詰所到着</th><td>${esc(fmtMDw(d.arrivalDate))} ${esc(d.arrivalTime)}</td></tr>
        <tr><th>出発</th><td>${esc(fmtMDw(d.departDate))} ${esc(d.departTime)}</td></tr>
        <tr><th>交通</th><td>${transportRow}</td></tr>
      </table>
      <h3>日別 内訳</h3>
      ${buildDaysTableHTML(d.days)}
      <div style="margin-top:8px;">直属食券 申込：${esc(fmtMD(d.ticketDate)||'')} ／ 食数 ${d.ticketCount||0}</div>
      <div style="margin-top:8px;">※直属食券が発行される日、申込〆切日をよくご確認ください。</div>
      <div style="margin-top:8px;"><strong>備考：</strong>${esc(d.note||'')}</div>
      <div style="margin-top:8px; font-weight:700;">◎変更や取消は到着2日前迄に必ずご連絡下さい。</div>
    `;
  }
  preview.innerHTML = buildPreview(data);

  // 画像化（scale=2）
  async function captureBlob(){
    const canvas = await html2canvas(cap, { scale:2, backgroundColor:'#fff' });
    return await new Promise(res => canvas.toBlob(b => res(b), 'image/png'));
  }

  document.getElementById('shareImage').addEventListener('click', async ()=>{
    // 先に空タブを開いておく（ブロック対策）
    const tmpTab = window.open('', '_blank');
    try{
      const blob = await captureBlob();
      const file = new File([blob], `kisantodoke_${Date.now()}.png`, { type:'image/png' });

      if (navigator.canShare && navigator.canShare({ files:[file] })) {
        if (tmpTab) tmpTab.close();
        await navigator.share({ files:[file], title: '帰参届', text: '帰参届（画像）' });
      } else {
        const url = URL.createObjectURL(blob);
        // まずは新しいタブで表示
        if (tmpTab) { tmpTab.location.href = url; }
        else { window.open(url, '_blank'); }

        // iOS等で新しいタブが真っ白な場合の最終手段：ページ内オーバーレイで表示
        setTimeout(()=>{
          try{
            const overlay = document.getElementById('overlay');
            const img = document.getElementById('shotImg');
            img.src = url;
            overlay.style.display = 'flex';
          }catch(_){}
        }, 300);

        // 後始末
        setTimeout(()=>URL.revokeObjectURL(url), 60000);
      }
    }catch(e){
      if (tmpTab) tmpTab.close();
      alert('画像の作成または共有に失敗しました: ' + e.message);
    }
  });

  document.getElementById('closeOverlay').addEventListener('click', ()=>{
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('shotImg').src = '';
  });

  document.getElementById('backEdit').addEventListener('click', ()=>{
    location.href = './index.html';
  });
</script>
</body>
</html>
