<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>帰参届（確認）</title>
<style>
  body{font-family:system-ui,sans-serif; padding:16px; max-width:860px; margin:0 auto; background:#f7f7f7;}
  h1{font-size:2rem; margin:8px 0 12px; text-align:center;}
  .wrap{background:#fff; padding:16px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.06);}
  table{width:100%; border-collapse:collapse; margin-top:8px;}
  th,td{border:1px solid #ddd; padding:6px; text-align:left;}
  .row-actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; justify-content:center;}
  .small{color:#666; font-size:.9rem; text-align:center; margin-top:6px;}
</style>
</head>
<body>
  <div id="cap" class="wrap">
    <h1>帰参届（確認）</h1>
    <div id="preview"></div>
  </div>
  <div class="row-actions">
    <button id="shareImage">画像で送る（スクショ）</button>
    <button id="saveImage">画像を保存</button>
    <button id="sendMail">メールで送信（テキスト）</button>
    <button id="sendLine">LINEで送る（テキスト）</button>
  </div>
  <div class="small"><a href="./index.html">入力に戻る</a></div>
  <!-- スクショ用ライブラリ（CDN） -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
  const TO_EMAIL = 'norinet.216@gmail.com';
  const SESSION_KEY = 'kisanFormV2';

  const data = JSON.parse(sessionStorage.getItem(SESSION_KEY) || 'null');
  if (!data){ location.href='./index.html'; }
  const preview = document.getElementById('preview');

  const WEEKS = ['日','月','火','水','木','金','土'];
  const fmtMD = (ymd)=>{ if(!ymd) return ''; const [y,m,d]=ymd.split('-'); return `${Number(m)}/${Number(d)}`; };
  const fmtMDw = (ymd)=> {
    if(!ymd) return '';
    const dt=new Date(ymd+'T00:00:00'); return `${fmtMD(ymd)}(${WEEKS[dt.getDay()]})`;
  };
  function esc(s=''){return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m] ));}

  // 画面プレビュー（HTML表）
  function buildDaysTableHTML(days){
    return `
      <table>
        <thead><tr><th>日付(曜)</th><th>朝食</th><th>昼食</th><th>夕食</th><th>宿泊</th></tr></thead>
        <tbody>
          ${days.map(d=>`<tr>
            <td>${esc(fmtMDw(d.date))}</td><td>${d.breakfast||0}</td><td>${d.lunch||0}</td><td>${d.dinner||0}</td><td>${d.stay||0}</td>
          </tr>`).join('')}
        </tbody>
      </table>
    `;
  }
  function buildPreview(d){
    const total=(d.adult||0)+(d.child||0)+(d.infant||0);
    return `
      <table>
        <tr><th>教会名（団体名）</th><td>${esc(d.kyokai)}</td></tr>
        <tr><th>帰参者名（代表）</th><td>${esc(d.kisan)}</td></tr>
        <tr><th>人数</th><td>大人${d.adult||0} 子供${d.child||0} 乳児${d.infant||0}（計${total}）</td></tr>
        <tr><th>詰所到着</th><td>${esc(fmtMDw(d.arrivalDate))} ${esc(d.arrivalTime)}</td></tr>
        <tr><th>出発</th><td>${esc(fmtMDw(d.departDate))} ${esc(d.departTime)}</td></tr>
        <tr><th>交通</th><td>${esc(d.transport.type)}（${esc(d.transport.detail)}）</td></tr>
        <tr><th>直属食券 申込</th><td>${esc(fmtMD(d.ticketDate)||'')} ／ 食数 ${d.ticketCount||0}</td></tr>
        <tr><th>備考</th><td>${esc(d.note||'')}</td></tr>
      </table>
      <h3>日別 内訳</h3>
      ${buildDaysTableHTML(d.days)}
      <div style="margin-top:8px;">※直属食券が発行される日、申込〆切日をよくご確認ください。</div>
      <div style="margin-top:8px; font-weight:700;">◎変更や取消は到着2日前迄に必ずご連絡下さい。</div>
    `;
  }
  preview.innerHTML = buildPreview(data);

  // メール/LINEの“見やすいテキスト”（従来どおりの送信方法も維持）
  function pad(str,len){str=String(str);const w=len-str.length;return str+(w>0?' '.repeat(w):'');}
  function buildDaysTableText(days){
    const header = `日付(曜)  | 朝 | 昼 | 夕 | 宿`;
    const bar =     `-----------+----+----+----+----`;
    const rows = (days||[]).map(d=>`${pad(fmtMDw(d.date),8)} | ${pad(d.breakfast||0,2)} | ${pad(d.lunch||0,2)} | ${pad(d.dinner||0,2)} | ${pad(d.stay||0,2)}`);
    const bullets = (days||[]).map(d=>`- ${fmtMDw(d.date)}: 朝${d.breakfast||0} 昼${d.lunch||0} 夕${d.dinner||0} 宿${d.stay||0}`);
    return [header, bar, ...rows, '', ...bullets].join('\n');
  }
  function buildText(d){
    const total=(d.adult||0)+(d.child||0)+(d.infant||0);
    return [
      '【帰参届】',
      `教会名（団体名）: ${d.kyokai}`,
      `帰参者名: ${d.kisan}`,
      `人数: 大人${d.adult||0} 子供${d.child||0} 乳児${d.infant||0}（計${total}）`,
      `詰所到着: ${fmtMDw(d.arrivalDate)} ${d.arrivalTime}`,
      `出発: ${fmtMDw(d.departDate)} ${d.departTime}`,
      `交通: ${d.transport.type}（${d.transport.detail}）`,
      `直属食券: ${fmtMD(d.ticketDate)||''} ／ 食数 ${d.ticketCount||0}`,
      `備考: ${d.note||''}`,
      '',
      '=== 日別 内訳 ===',
      buildDaysTableText(d.days),
      '',
      '※直属食券が発行される日、申込〆切日をよくご確認ください。',
      '◎変更や取消は到着2日前迄に必ずご連絡下さい。',
      `送信: ${new Date().toLocaleString('ja-JP',{timeZone:'Asia/Tokyo'})}`
    ].join('\n');
  }

  // 画像化して共有（スクショ）
  async function captureBlob(){
    const el = document.getElementById('cap');
    const canvas = await html2canvas(el, { scale:2, backgroundColor:'#fff' });
    return await new Promise(res => canvas.toBlob(b => res(b), 'image/png'));
  }

  document.getElementById('shareImage').addEventListener('click', async ()=>{
    try{
      const blob = await captureBlob();
      const file = new File([blob], `kisantodoke_${Date.now()}.png`, { type:'image/png' });
      const subject = `【帰参届】${data.kyokai}／${data.kisan}（${fmtMD(data.arrivalDate)} 到着）`;

      // Web Share API Level 2（対応端末なら画像を直接メール/LINEに添付）
      if (navigator.canShare && navigator.canShare({ files:[file] })) {
        await navigator.share({ files:[file], title: subject, text: '帰参届（画像）' });
      } else {
        // 画像を保存して手動共有
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = file.name;
        a.click();
        URL.revokeObjectURL(a.href);
        alert('画像を保存しました。メール/LINEで画像を添付して送ってください。');
      }
    }catch(e){ alert('画像の作成に失敗しました: ' + e.message); }
  });

  // 画像だけ保存
  document.getElementById('saveImage').addEventListener('click', async ()=>{
    try{
      const blob = await captureBlob();
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `kisantodoke_${Date.now()}.png`;
      a.click();
      URL.revokeObjectURL(a.href);
    }catch(e){ alert('保存に失敗しました: ' + e.message); }
  });

  // テキストでメール/LINE（従来）
  document.getElementById('sendMail').addEventListener('click', ()=>{
    const subject = `【帰参届】${data.kyokai}／${data.kisan}（${fmtMD(data.arrivalDate)} 到着）`;
    const body = buildText(data);
    location.href = `mailto:${encodeURIComponent(TO_EMAIL)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  });
  document.getElementById('sendLine').addEventListener('click', ()=>{
    const text = buildText(data);
    window.open(`https://line.me/R/msg/text/?${encodeURIComponent(text)}`,'_blank');
  });
</script>
</body>
</html>
