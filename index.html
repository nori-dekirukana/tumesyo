<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>帰参届</title>
<style>
  body{font-family:system-ui, sans-serif; padding:16px; max-width:860px; margin:0 auto;}
  h1{font-size:2.2rem; margin:8px 0 16px; text-align:center;}
  label{display:block; margin:12px 0 6px; font-weight:700;}
  input, select, button, textarea{width:100%; padding:10px; font-size:16px; box-sizing:border-box;}
  textarea{min-height:96px;}
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:8px;}
  .grid3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;}
  .box{border:1px solid #ddd; padding:12px; border-radius:6px; margin-top:8px;}
  table{width:100%; border-collapse:collapse; margin-top:8px;}
  th,td{border:1px solid #ddd; padding:10px; text-align:left;}
  .row-actions{display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; justify-content:center;}
  .small{font-size:.9rem; color:#666;}
  .muted{color:#666;}
  .radio{display:flex; gap:16px; margin:6px 0;}
  .radio label{font-weight:400;}
/* スマホの大きな文字設定でも入力が見切れないように */
#daysTable input[type=number]{width:100%; min-width:0; font-size:18px;}
#daysTable input[type=date]{width:100%; min-width:0; font-size:14px;}
@media (max-width:480px){
table{font-size:15px;}
th,td{padding:8px;}
}
</style>
</head>
<body>
  <h1>帰参届</h1>
  <form id="form" autocomplete="off" novalidate>
    <label>教会名（団体名）</label>
    <input type="text" name="kyokai" required>
コードをコピーする<label>帰参者名（代表）</label>
<input type="text" name="kisan" required>

<div class="box">
  <strong>人数</strong>
  <div class="grid3">
    <div><label class="muted">大人</label><input type="number" name="adult" min="0" inputmode="numeric" placeholder=""></div>
    <div><label class="muted">子供</label><input type="number" name="child" min="0" inputmode="numeric" placeholder=""></div>
    <div><label class="muted">乳児</label><input type="number" name="infant" min="0" inputmode="numeric" placeholder=""></div>
  </div>
</div>

<div class="box">
  <strong>詰所到着・出発</strong>
  <div class="grid2">
    <div>
      <label class="muted">詰所到着 日付</label>
      <input type="date" name="arrivalDate" required>
    </div>
    <div>
      <label class="muted">詰所到着 予定時間</label>
      <input type="time" name="arrivalTime" required>
    </div>
    <div>
      <label class="muted">出発 日付</label>
      <input type="date" name="departDate" required>
    </div>
    <div>
      <label class="muted">出発 予定時間</label>
      <input type="time" name="departTime" required>
    </div>
  </div>
</div>

<div class="box">
  <strong>交通</strong>
  <div class="radio">
    <label><input type="radio" name="transportType" value="公共交通" checked> 公共交通</label>
    <label><input type="radio" name="transportType" value="独自"> 独自</label>
  </div>
  <div id="publicWrap">
    <label class="muted">公共交通の種別</label>
    <select name="publicTransport">
      <option value="鉄道">鉄道</option>
      <option value="夜行バス">夜行バス</option>
    </select>
  </div>
  <div id="privateWrap" style="display:none;">
    <label class="muted">独自の種別</label>
    <select name="privateTransport">
      <option value="観光バス">観光バス</option>
      <option value="マイクロバス">マイクロバス</option>
      <option value="乗用車">乗用車</option>
      <option value="他">他</option>
    </select>
    <input type="text" name="privateOther" placeholder="他の場合は入力" style="margin-top:6px;">
    <div id="carCountWrap" class="grid2" style="display:none; margin-top:8px;">
      <div>
        <label class="muted">台数（乗用車）</label>
        <input type="number" name="carCount" min="1" inputmode="numeric" placeholder="">
      </div>
    </div>
  </div>
</div>

<div class="box">
  <strong>日付ごとの 食事・宿泊</strong>
  <div class="small">到着日と出発日を入れると、自動で期間が表示されます（数値は空欄でOK）。</div>
  <table id="daysTable">
    <thead>
      <tr><th>日付</th><th>朝食</th><th>昼食</th><th>夕食</th><th>宿泊</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="box">
  <strong>直属食券 申込</strong>
  <div class="grid2">
    <div>
      <label class="muted">日付</label>
      <input type="date" name="ticketDate">
    </div>
    <div>
      <label class="muted">食数</label>
      <input type="number" name="ticketCount" min="0" inputmode="numeric" placeholder="">
    </div>
  </div>
  <div class="small">※直属食券が発行される日、申込〆切日をよくご確認ください。</div>
</div>

<div class="box">
  <strong>備考</strong>
  <textarea name="note" placeholder="女性部屋希望などありましたら、こちらにご記入ください"></textarea>
</div>

<div class="row-actions">
  <button type="submit" id="goConfirm">確認ページへ</button>
</div>

  </form>
<script>
  const SESSION_KEY = 'kisanFormV2';
  const form = document.getElementById('form');
  const tbody = document.querySelector('#daysTable tbody');
  const carCountWrap = document.getElementById('carCountWrap');

  function updatePrivateExtras(){
    const type = form.elements['transportType'].value;
    const detail = form.elements['privateTransport'].value;
    carCountWrap.style.display = (type==='独自' && detail==='乗用車') ? 'grid' : 'none';
  }
  function updateTransportUI(){
    const t = form.elements['transportType'].value;
    document.getElementById('publicWrap').style.display = (t==='公共交通')?'block':'none';
    document.getElementById('privateWrap').style.display = (t==='独自')?'block':'none';
    updatePrivateExtras();
  }
  form.addEventListener('change', e=>{
    if (e.target.name === 'transportType' || e.target.name === 'privateTransport') updateTransportUI();
  });

  function z(n){return String(n).padStart(2,'0');}
  function rangeDates(a,b){
    const out=[]; const s=new Date(a+'T00:00:00'); const e=new Date(b+'T00:00:00');
    if (isNaN(s)||isNaN(e)||s>e) return out;
    for(let d=new Date(s); d<=e; d.setDate(d.getDate()+1)){
      out.push(`${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`);
    }
    return out;
  }
  function renderDaysFromRange(){
    const a=form.elements['arrivalDate'].value, b=form.elements['departDate'].value;
    if(!a||!b){ tbody.innerHTML=''; return; }
    const dates=rangeDates(a,b);
    tbody.innerHTML = dates.map(d=>`
      <tr>
        <td><input type="date" value="${d}"></td>
        <td><input type="number" min="0" inputmode="numeric" placeholder=""></td>
        <td><input type="number" min="0" inputmode="numeric" placeholder=""></td>
        <td><input type="number" min="0" inputmode="numeric" placeholder=""></td>
        <td><input type="number" min="0" inputmode="numeric" placeholder=""></td>
      </tr>`).join('');
  }
  function renderDaysFromData(days=[]){
    if(!days || !days.length){ tbody.innerHTML=''; return; }
    tbody.innerHTML = days.map(r=>`
      <tr>
        <td><input type="date" value="${r.date||''}"></td>
        <td><input type="number" min="0" inputmode="numeric" placeholder="" value="${r.breakfast||''}"></td>
        <td><input type="number" min="0" inputmode="numeric" placeholder="" value="${r.lunch||''}"></td>
        <td><input type="number" min="0" inputmode="numeric" placeholder="" value="${r.dinner||''}"></td>
        <td><input type="number" min="0" inputmode="numeric" placeholder="" value="${r.stay||''}"></td>
      </tr>`).join('');
  }
  form.elements['arrivalDate'].addEventListener('change', renderDaysFromRange);
  form.elements['departDate'].addEventListener('change', renderDaysFromRange);

  function collectDays(){
    const rows=[]; tbody.querySelectorAll('tr').forEach(tr=>{
      const [date,bf,lu,di,st]=tr.querySelectorAll('input');
      if(date.value) rows.push({
        date: date.value,
        breakfast: Number(bf.value||0),
        lunch: Number(lu.value||0),
        dinner: Number(di.value||0),
        stay: Number(st.value||0),
      });
    });
    return rows;
  }
  function getTransport(){
    const type = form.elements['transportType'].value;
    if (type==='公共交通') return { type, detail: form.elements['publicTransport'].value };
    const d = form.elements['privateTransport'].value;
    const other = (d==='他') ? (form.elements['privateOther'].value||'他') : d;
    return { type, detail: other };
  }
  function n(v){ return Number(v||0); }

  function restoreFromSession(){
    const raw = sessionStorage.getItem(SESSION_KEY);
    if (!raw) return;
    try{
      const d = JSON.parse(raw);
      form.elements['kyokai'].value = d.kyokai || '';
      form.elements['kisan'].value = d.kisan || '';
      form.elements['adult'].value = (d.adult ?? '');
      form.elements['child'].value = (d.child ?? '');
      form.elements['infant'].value = (d.infant ?? '');
      form.elements['arrivalDate'].value = d.arrivalDate || '';
      form.elements['arrivalTime'].value = d.arrivalTime || '';
      form.elements['departDate'].value = d.departDate || '';
      form.elements['departTime'].value = d.departTime || '';
      if (d.transport?.type === '独自') form.elements['transportType'].value = '独自';
      updateTransportUI();
      if (d.transport?.type === '公共交通') {
        form.elements['publicTransport'].value = d.transport.detail || '鉄道';
      } else {
        form.elements['privateTransport'].value = ['観光バス','マイクロバス','乗用車','他'].includes(d.transport?.detail) ? d.transport.detail : '他';
        form.elements['privateOther'].value = (['観光バス','マイクロバス','乗用車'].includes(d.transport?.detail)) ? '' : (d.transport?.detail || '');
        form.elements['carCount'].value = (d.carCount ?? '');
        updatePrivateExtras();
      }
      renderDaysFromData(d.days||[]);
      form.elements['ticketDate'].value = d.ticketDate || '';
      form.elements['ticketCount'].value = (d.ticketCount ?? '');
      form.elements['note'].value = d.note || '';
    }catch{}
  }

  window.addEventListener('load', ()=>{
    updateTransportUI();
    restoreFromSession();
  });

  form.addEventListener('submit', (e)=>{
    e.preventDefault();

    // 乗用車のとき台数チェック
    if (form.elements['transportType'].value==='独自' && form.elements['privateTransport'].value==='乗用車') {
      const c = form.elements['carCount'].value.trim();
      if (!c) { alert('乗用車の台数を入力してください'); return; }
    }

    // 日別が空なら自動生成してから送る（復帰直後の対策）
    if (tbody.children.length===0) renderDaysFromRange();

    const data = {
      kyokai: form.elements['kyokai'].value.trim(),
      kisan: form.elements['kisan'].value.trim(),
      adult: n(form.elements['adult'].value),
      child: n(form.elements['child'].value),
      infant: n(form.elements['infant'].value),
      arrivalDate: form.elements['arrivalDate'].value,
      arrivalTime: form.elements['arrivalTime'].value,
      departDate: form.elements['departDate'].value,
      departTime: form.elements['departTime'].value,
      transport: getTransport(),
      carCount: n(form.elements['carCount'].value),
      days: collectDays(),
      ticketDate: form.elements['ticketDate'].value || '',
      ticketCount: n(form.elements['ticketCount'].value),
      note: form.elements['note'].value || '',
      now: new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })
    };

    if (!data.kyokai || !data.kisan || !data.arrivalDate || !data.arrivalTime || !data.departDate || !data.departTime){
      alert('未入力の必須項目があります'); return;
    }
    if (data.days.length===0){ alert('到着日と出発日を入れてください（期間が自動表示されます）'); return; }

    sessionStorage.setItem(SESSION_KEY, JSON.stringify(data));
    location.href = './confirm.html';
  });
</script>
</body>
</html>
