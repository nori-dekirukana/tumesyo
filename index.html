<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>帰参届</title>
<style>
  body{font-family:system-ui, sans-serif; padding:16px; max-width:860px; margin:0 auto;}
  h1{font-size:1.8rem; margin:0 0 12px;}
  label{display:block; margin:12px 0 6px; font-weight:700;}
  input, select, button, textarea{width:100%; padding:10px; font-size:16px; box-sizing:border-box;}
  textarea{min-height:96px;}
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:8px;}
  .grid3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;}
  .box{border:1px solid #ddd; padding:12px; border-radius:6px; margin-top:8px;}
  table{width:100%; border-collapse:collapse; margin-top:8px;}
  th,td{border:1px solid #ddd; padding:6px; text-align:left;}
  .row-actions{display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;}
  .small{font-size:.9rem; color:#666;}
  .muted{color:#666;}
  .radio{display:flex; gap:16px; margin:6px 0;}
  .radio label{font-weight:400;}
  .right{text-align:right;}
  nav a{margin-right:12px;}
  .note{margin-top:8px; color:#444;}
  .warn{margin-top:12px; font-weight:700;}
</style>
</head>
<body>
  <nav>
    <a href="./index.html">入力</a>
    <a href="./history.html">履歴</a>
  </nav>
  <h1>帰参届</h1>
  <form id="form">
    <label>教会名（団体名）</label>
    <input type="text" name="kyokai" required>
コードをコピーする<label>帰参者名（代表）</label>
<input type="text" name="kisan" required>

<div class="box">
  <strong>人数</strong>
  <div class="grid3">
    <div><label class="muted">大人</label><input type="number" name="adult" min="0" placeholder=""></div>
    <div><label class="muted">子供</label><input type="number" name="child" min="0" placeholder=""></div>
    <div><label class="muted">乳児</label><input type="number" name="infant" min="0" placeholder=""></div>
  </div>
</div>

<div class="box">
  <strong>詰所到着・出発</strong>
  <div class="grid2">
    <div>
      <label class="muted">詰所到着 日付</label>
      <input type="date" name="arrivalDate" required>
    </div>
    <div>
      <label class="muted">詰所到着 予定時間</label>
      <input type="time" name="arrivalTime" required>
    </div>
    <div>
      <label class="muted">出発 日付</label>
      <input type="date" name="departDate" required>
    </div>
    <div>
      <label class="muted">出発 予定時間</label>
      <input type="time" name="departTime" required>
    </div>
  </div>
</div>

<div class="box">
  <strong>交通</strong>
  <div class="radio">
    <label><input type="radio" name="transportType" value="公共交通" checked> 公共交通</label>
    <label><input type="radio" name="transportType" value="独自"> 独自</label>
  </div>
  <div id="publicWrap">
    <label class="muted">公共交通の種別</label>
    <select name="publicTransport">
      <option value="鉄道">鉄道</option>
      <option value="夜行バス">夜行バス</option>
    </select>
  </div>
  <div id="privateWrap" style="display:none;">
    <label class="muted">独自の種別</label>
    <select name="privateTransport">
      <option value="観光バス">観光バス</option>
      <option value="マイクロバス">マイクロバス</option>
      <option value="乗用車">乗用車</option>
      <option value="他">他</option>
    </select>
    <input type="text" name="privateOther" placeholder="他の場合は入力">
  </div>
</div>

<div class="box">
  <strong>日付ごとの 食事・宿泊</strong>
  <div class="small">各日について、必要数を入力してください（空欄可）。</div>
  <table id="daysTable">
    <thead>
      <tr>
        <th>日付</th><th>朝食</th><th>昼食</th><th>夕食</th><th>宿泊</th><th class="right">操作</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="row-actions">
    <button type="button" id="addRowBtn">行を追加</button>
    <button type="button" id="autoFillBtn">到着〜出発の期間を自動追加</button>
  </div>
</div>

<div class="box">
  <strong>直属食券 申込</strong>
  <div class="grid2">
    <div>
      <label class="muted">日付</label>
      <input type="date" name="ticketDate">
    </div>
    <div>
      <label class="muted">食数</label>
      <input type="number" name="ticketCount" min="0" placeholder="">
    </div>
  </div>
  <div class="note">※直属食券が発行される日、申込〆切日をよくご確認ください。</div>
</div>

<div class="box">
  <strong>備考</strong>
  <textarea name="note" placeholder="自由入力"></textarea>
</div>

<div class="warn">◎変更や取消は到着2日前迄に必ずご連絡下さい。</div>

<div class="row-actions">
  <button type="submit" id="goConfirm">確認ページへ</button>
  <a class="small" href="./history.html">履歴を見る</a>
</div>

  </form>
<script>
  const SESSION_KEY = 'kisanFormV2';
  const form = document.getElementById('form');
  const daysTbody = document.querySelector('#daysTable tbody');
  const addRowBtn = document.getElementById('addRowBtn');
  const autoFillBtn = document.getElementById('autoFillBtn');

  // 交通の切替
  form.addEventListener('change', e=>{
    if (e.target.name === 'transportType') {
      const t = e.target.value;
      document.getElementById('publicWrap').style.display = (t==='公共交通')?'block':'none';
      document.getElementById('privateWrap').style.display = (t==='独自')?'block':'none';
    }
  });

  function z(n){return String(n).padStart(2,'0');}
  function addRow(dateStr=''){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="date" value="${dateStr}"></td>
      <td><input type="number" min="0" style="width:90px" placeholder=""></td>
      <td><input type="number" min="0" style="width:90px" placeholder=""></td>
      <td><input type="number" min="0" style="width:90px" placeholder=""></td>
      <td><input type="number" min="0" style="width:90px" placeholder=""></td>
      <td class="right"><button type="button" data-act="del">削除</button></td>
    `;
    daysTbody.appendChild(tr);
  }
  function dateRange(start, end){
    const out=[]; const s=new Date(start+'T00:00:00'); const e=new Date(end+'T00:00:00');
    if (isNaN(s)||isNaN(e)||s>e) return out;
    for (let d=new Date(s); d<=e; d.setDate(d.getDate()+1)){
      out.push(`${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`);
    }
    return out;
  }
  addRowBtn.addEventListener('click', ()=>addRow(''));
  autoFillBtn.addEventListener('click', ()=>{
    const a=form.elements['arrivalDate'].value, b=form.elements['departDate'].value;
    if(!a||!b){ alert('詰所到着日と出発日を先に入力してください'); return; }
    daysTbody.innerHTML=''; for(const d of dateRange(a,b)) addRow(d);
  });
  daysTbody.addEventListener('click', (e)=>{
    const btn=e.target.closest('button'); if(!btn) return;
    if(btn.dataset.act==='del') btn.closest('tr').remove();
  });
  addRow(''); // 初期行

  function collectDays(){
    const rows=[]; daysTbody.querySelectorAll('tr').forEach(tr=>{
      const [date, bf, lu, di, stay] = tr.querySelectorAll('input');
      if (date.value) rows.push({
        date: date.value,
        breakfast: Number((bf.value||0)),
        lunch: Number((lu.value||0)),
        dinner: Number((di.value||0)),
        stay: Number((stay.value||0)),
      });
    });
    return rows;
  }
  function getTransport(){
    const type = form.elements['transportType'].value;
    if (type==='公共交通') return { type, detail: form.elements['publicTransport'].value };
    const d = form.elements['privateTransport'].value;
    const other = (d==='他') ? (form.elements['privateOther'].value||'他') : d;
    return { type, detail: other };
  }
  function n(v){ return Number(v||0); }

  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    const days = collectDays();
    if (days.length===0){ alert('少なくとも1日分の「日付」を入力してください'); return; }

    const data = {
      kyokai: form.elements['kyokai'].value.trim(),
      kisan: form.elements['kisan'].value.trim(),
      adult: n(form.elements['adult'].value),
      child: n(form.elements['child'].value),
      infant: n(form.elements['infant'].value),
      arrivalDate: form.elements['arrivalDate'].value,
      arrivalTime: form.elements['arrivalTime'].value,
      departDate: form.elements['departDate'].value,
      departTime: form.elements['departTime'].value,
      transport: getTransport(),
      days,
      ticketDate: form.elements['ticketDate'].value || '',
      ticketCount: n(form.elements['ticketCount'].value),
      note: form.elements['note'].value || '',
      now: new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })
    };

    if (!data.kyokai || !data.kisan || !data.arrivalDate || !data.arrivalTime || !data.departDate || !data.departTime){
      alert('未入力の必須項目があります'); return;
    }
    sessionStorage.setItem(SESSION_KEY, JSON.stringify(data));
    location.href = './confirm.html';
  });
</script>
</body>
</html>
