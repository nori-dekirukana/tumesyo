
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>詰所 申込フォーム（超シンプル＋履歴）</title>
  <style>
    body { font-family: system-ui, sans-serif; padding: 16px; max-width: 760px; margin: 0 auto; }
    h1 { font-size: 1.2rem; }
    label { display:block; margin: 12px 0 4px; font-weight: 600; }
    input, select, button { width: 100%; padding: 10px; font-size: 16px; box-sizing: border-box; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
    .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    .btns { display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
    .hint { color:#666; font-size:0.9rem; }
    pre { background:#f6f7f8; padding:10px; overflow:auto; }
    .hide { display:none; }
    .sec { margin-top: 20px; }
    .tag { display:inline-block; font-size:0.85rem; color:#555; background:#eef; padding:2px 6px; border-radius:4px; margin-left:6px; }
    .small { font-size: 0.9rem; color:#666; }
    .right { text-align:right; }
  </style>
</head>
<body>
  <h1>詰所 申込フォーム <span class="tag">宛先: norinet.216@gmail.com</span></h1>
  <form id="form">
    <label>教会名</label>
    <input type="text" name="kyokai" required>
コードをコピーする<label>帰参者名</label>
<input type="text" name="kisan" required>

<label>人数（大人/子供/乳児）</label>
<div class="row3">
  <input type="number" name="adult" min="0" value="1" placeholder="大人" required>
  <input type="number" name="child" min="0" value="0" placeholder="子供">
  <input type="number" name="infant" min="0" value="0" placeholder="乳児">
</div>

<label>詰所到着日</label>
<input type="date" name="arrivalDate" required>

<label>到着予定時間</label>
<input type="time" name="arrivalTime" required>

<label>交通</label>
<select name="transport" required>
  <option value="電車">電車</option>
  <option value="車">車</option>
  <option value="バス">バス</option>
  <option value="その他">その他</option>
</select>

<label>宿泊</label>
<div class="row2">
  <select name="stay" required>
    <option value="あり" selected>あり</option>
    <option value="なし">なし</option>
  </select>
  <input type="number" name="nights" min="1" value="1" placeholder="泊数">
</div>

<label>食事の数</label>
<div class="row3">
  <input type="number" name="breakfast" min="0" value="0" placeholder="朝食">
  <input type="number" name="lunch" min="0" value="0" placeholder="昼食">
  <input type="number" name="dinner" min="0" value="0" placeholder="夕食">
</div>

<label>送信者メール（控えを自分にBcc・任意）</label>
<input type="email" name="senderEmail" placeholder="例）example@example.jp">

<div class="btns">
  <button type="button" id="btnPreview">プレビュー更新</button>
  <button type="button" id="btnCopy">本文をコピー</button>
  <button type="button" id="btnSaveText">テキスト保存（端末へ）</button>
  <button type="button" id="btnShare" class="hide">共有（スマホ推奨）</button>
  <button type="button" id="btnMail">メールで送信</button>
  <button type="button" id="btnLine">LINEで送る</button>
</div>
<div class="hint">送信ボタンでスマホのメール/LINEアプリが開きます。控えを残したい場合は「送信者メール」に自分のアドレスを入れてください（Bcc）。履歴はこの端末に保存されます。</div>

  </form>
  <div id="preview" class="sec"></div>
  <div class="sec">
    <h2>送信本文（テキスト）</h2>
    <pre id="textOut"></pre>
  </div>
  <div class="sec">
    <h2>履歴 <span class="small">（この端末内・最大100件）</span></h2>
    <div class="btns">
      <button type="button" id="btnExportCsv">CSVで保存</button>
      <button type="button" id="btnClearHistory">履歴を全削除</button>
    </div>
    <table id="historyTable">
      <thead>
        <tr><th>時刻</th><th>教会名</th><th>帰参者名</th><th>到着</th><th class="right">操作</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
<script>
  // 宛先メール（ご指定どおり）
  const TO_EMAIL = 'norinet.216@gmail.com';
  const SUBJECT_PREFIX = '【詰所申込】';
  const HISTORY_KEY = 'tsumeshoHistoryV1';
  const HISTORY_MAX = 100;

  const form = document.getElementById('form');
  const preview = document.getElementById('preview');
  const textOut = document.getElementById('textOut');
  const btnPreview = document.getElementById('btnPreview');
  const btnCopy = document.getElementById('btnCopy');
  const btnShare = document.getElementById('btnShare');
  const btnMail = document.getElementById('btnMail');
  const btnLine = document.getElementById('btnLine');
  const btnSaveText = document.getElementById('btnSaveText');
  const historyTableBody = document.querySelector('#historyTable tbody');
  const btnExportCsv = document.getElementById('btnExportCsv');
  const btnClearHistory = document.getElementById('btnClearHistory');

  if (navigator.share) btnShare.classList.remove('hide');

  function getData() {
    const d = Object.fromEntries(new FormData(form).entries());
    const n = (k) => Number(d[k] || 0);
    d.total = n('adult') + n('child') + n('infant');
    d.now = new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' });
    if (d.stay === 'なし') d.nights = '0';
    return d;
  }

  function buildText(d) {
    return [
      '【詰所 申込】',
      `教会名: ${d.kyokai || ''}`,
      `帰参者名: ${d.kisan || ''}`,
      `人数: 大人${d.adult||0} 子供${d.child||0} 乳児${d.infant||0}（計${d.total||0}）`,
      `到着: ${d.arrivalDate || ''} ${d.arrivalTime || ''}`,
      `交通: ${d.transport || ''}`,
      `宿泊: ${d.stay || ''}${d.stay==='あり' ? `（${d.nights||0}泊）` : ''}`,
      `食事: 朝${d.breakfast||0} 昼${d.lunch||0} 夜${d.dinner||0}`,
      `送信: ${d.now || ''}`
    ].join('\n');
  }

  function escapeHtml(str='') {
    return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
  }

  function buildPreviewTable(d) {
    return `
      <h2>プレビュー</h2>
      <table>
        <tr><th>教会名</th><td>${escapeHtml(d.kyokai || '')}</td></tr>
        <tr><th>帰参者名</th><td>${escapeHtml(d.kisan || '')}</td></tr>
        <tr><th>人数</th><td>大人${d.adult||0} 子供${d.child||0} 乳児${d.infant||0}（計${d.total||0}）</td></tr>
        <tr><th>到着</th><td>${escapeHtml(d.arrivalDate||'')} ${escapeHtml(d.arrivalTime||'')}</td></tr>
        <tr><th>交通</th><td>${escapeHtml(d.transport||'')}</td></tr>
        <tr><th>宿泊</th><td>${escapeHtml(d.stay||'')}${d.stay==='あり' ? `（${escapeHtml(d.nights||'0')}泊）` : ''}</td></tr>
        <tr><th>食事</th><td>朝${d.breakfast||0} 昼${d.lunch||0} 夜${d.dinner||0}</td></tr>
        <tr><th>作成時刻</th><td>${escapeHtml(d.now||'')}</td></tr>
      </table>
    `;
  }

  function updatePreview() {
    const d = getData();
    textOut.textContent = buildText(d);
    preview.innerHTML = buildPreviewTable(d);
  }

  // 履歴
  function loadHistory() {
    try { return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]'); }
    catch { return []; }
  }
  function saveHistory(arr) {
    localStorage.setItem(HISTORY_KEY, JSON.stringify(arr.slice(0, HISTORY_MAX)));
  }
  function addToHistory(d) {
    const h = loadHistory();
    h.unshift({ ...d, savedAt: new Date().toISOString() });
    saveHistory(h);
    renderHistory();
  }
  function renderHistory() {
    const h = loadHistory();
    historyTableBody.innerHTML = h.map((e, i) => {
      const when = new Date(e.savedAt).toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' });
      const arr = (e.arrivalDate || '') + ' ' + (e.arrivalTime || '');
      return `<tr>
        <td>${escapeHtml(when)}</td>
        <td>${escapeHtml(e.kyokai || '')}</td>
        <td>${escapeHtml(e.kisan || '')}</td>
        <td>${escapeHtml(arr.trim())}</td>
        <td class="right">
          <button data-act="restore" data-idx="${i}">復元</button>
          <button data-act="view" data-idx="${i}">表示</button>
          <button data-act="del" data-idx="${i}">削除</button>
        </td>
      </tr>`;
    }).join('');
  }
  historyTableBody.addEventListener('click', (e) => {
    const btn = e.target.closest('button'); if (!btn) return;
    const idx = Number(btn.dataset.idx);
    const act = btn.dataset.act;
    const h = loadHistory();
    const item = h[idx];
    if (!item) return;
    if (act === 'restore') {
      Object.keys(item).forEach(k => {
        if (form.elements[k] && k !== 'savedAt' && k !== 'total' && k !== 'now') {
          form.elements[k].value = item[k];
        }
      });
      updatePreview();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } else if (act === 'view') {
      alert(buildText(item));
    } else if (act === 'del') {
      h.splice(idx, 1);
      saveHistory(h);
      renderHistory();
    }
  });

  // CSV出力
  function exportCsv() {
    const h = loadHistory();
    const headers = ['保存時刻','教会名','帰参者名','大人','子供','乳児','到着日','到着時間','交通','宿泊','泊数','朝','昼','夜'];
    const rows = h.map(e => [
      new Date(e.savedAt).toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' }),
      e.kyokai||'', e.kisan||'',
      e.adult||0, e.child||0, e.infant||0,
      e.arrivalDate||'', e.arrivalTime||'',
      e.transport||'',
      e.stay||'', e.nights||'',
      e.breakfast||0, e.lunch||0, e.dinner||0
    ]);
    const csv = [headers, ...rows].map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\r\n');
    const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'tsumesho_history.csv';
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // イベント
  btnPreview.addEventListener('click', updatePreview);
  form.addEventListener('input', updatePreview);
  window.addEventListener('load', () => { updatePreview(); renderHistory(); });

  // 共有（スマホ）
  btnShare.addEventListener('click', async () => {
    const d = getData();
    const subject = `${SUBJECT_PREFIX}${d.kyokai}／${d.kisan}（${d.arrivalDate} 到着）`;
    const text = buildText(d);
    try { await navigator.share({ title: subject, text }); } catch {}
    addToHistory(d);
  });

  // メール送信（端末のメールアプリ）
  btnMail.addEventListener('click', () => {
    const d = getData();
    const subject = `${SUBJECT_PREFIX}${d.kyokai}／${d.kisan}（${d.arrivalDate} 到着）`;
    const body = buildText(d);
    const bcc = (d.senderEmail || '').trim();
    let url = `mailto:${encodeURIComponent(TO_EMAIL)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    if (bcc) url += `&bcc=${encodeURIComponent(bcc)}`;
    window.location.href = url;
    addToHistory(d);
  });

  // LINE送信（アプリ起動）
  btnLine.addEventListener('click', () => {
    const d = getData();
    const text = buildText(d);
    const url = `https://line.me/R/msg/text/?${encodeURIComponent(text)}`;
    window.open(url, '_blank');
    addToHistory(d);
  });

  // コピー
  btnCopy.addEventListener('click', async () => {
    const d = getData();
    try {
      await navigator.clipboard.writeText(buildText(d));
      btnCopy.textContent = 'コピーしました';
      setTimeout(() => btnCopy.textContent = '本文をコピー', 1500);
    } catch {
      alert('コピーできませんでした。手動で選択してコピーしてください。');
    }
  });

  // 端末へテキスト保存
  btnSaveText.addEventListener('click', () => {
    const d = getData();
    const text = buildText(d);
    const fileName = `申込_${(d.arrivalDate||'日付未定')}_${Date.now()}.txt`;
    const blob = new Blob([text], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = fileName;
    a.click();
    URL.revokeObjectURL(a.href);
    addToHistory(d);
  });

  // 宿泊切替で泊数の表示制御
  form.elements['stay'].addEventListener('change', (e) => {
    const show = e.target.value === 'あり';
    form.elements['nights'].parentElement.style.display = show ? 'block' : 'none';
    if (!show) form.elements['nights'].value = '0';
    updatePreview();
  });
</script>
</body>
</html>