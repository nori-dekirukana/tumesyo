<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>帰参届（履歴）</title>
<style>
  body{font-family:system-ui,sans-serif; padding:16px; max-width:960px; margin:0 auto;}
  h1{font-size:1.3rem; margin:0 0 12px;}
  table{width:100%; border-collapse:collapse; margin-top:8px;}
  th,td{border:1px solid #ddd; padding:6px; text-align:left; vertical-align:top;}
  .row-actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:12px;}
  nav a{margin-right:12px;}
  .right{text-align:right;}
  pre{white-space:pre-wrap; background:#f6f7f8; padding:8px;}
</style>
</head>
<body>
  <nav>
    <a href="./index.html">入力</a>
    <a href="./history.html">履歴</a>
  </nav>
  <h1>帰参届（履歴）</h1>
  <div class="row-actions">
    <button id="exportCsv">CSVで保存</button>
    <button id="clearAll">履歴を全削除</button>
  </div>
  <table id="tbl">
    <thead>
      <tr>
        <th>保存時刻</th><th>教会名</th><th>帰参者名</th><th>到着</th><th>発</th><th>詳細</th><th class="right">操作</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
<script>
  const HISTORY_KEY = 'kisanHistoryV2';
  const SESSION_KEY = 'kisanFormV2';
  const TO_EMAIL = 'norinet.216@gmail.com';

  function load(){ try{return JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]');}catch{return[];} }
  function save(arr){ localStorage.setItem(HISTORY_KEY, JSON.stringify(arr)); }
  function esc(s=''){return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

  function buildText(d){
    const lines = [
      '【帰参届】',
      `教会名: ${d.kyokai}`,
      `帰参者名: ${d.kisan}`,
      `人数: 大人${d.adult} 子供${d.child} 乳児${d.infant}（計${(d.adult||0)+(d.child||0)+(d.infant||0)}）`,
      `到着: ${d.arrivalDate} ${d.arrivalTime}`,
      `発: ${d.departDate} ${d.departTime}`,
      `交通: ${d.transport?.type}（${d.transport?.detail}）`,
      `直属食券: ${d.ticketDate||''} ／ 食数 ${d.ticketCount||0}`,
      `備考: ${d.note||''}`,
      '日別内訳:'
    ];
    (d.days||[]).forEach(r=>lines.push(`- ${r.date}: 朝${r.breakfast} 昼${r.lunch} 夜${r.dinner} 宿泊${r.stay}`));
    lines.push('※直属食券が発行される日、申込〆切日をよくご確認ください。');
    lines.push('◎変更や取消は到着2日前迄に必ずご連絡下さい。');
    return lines.join('\n');
  }

  function render(){
    const h = load();
    const tbody = document.querySelector('#tbl tbody');
    tbody.innerHTML = h.map((e,i)=>{
      const when = new Date(e.savedAt||Date.now()).toLocaleString('ja-JP',{timeZone:'Asia/Tokyo'});
      const detail = [
        `人数: 大${e.adult} 子${e.child} 乳${e.infant}`,
        `交通: ${e.transport?.type}（${e.transport?.detail}）`,
        `直属食券: ${e.ticketDate||''}／${e.ticketCount||0}`,
        ...((e.days||[]).map(r=>`- ${r.date}: 朝${r.breakfast} 昼${r.lunch} 夜${r.dinner} 宿${r.stay}`))
      ].join('<br>');
      return `<tr>
        <td>${esc(when)}</td>
        <td>${esc(e.kyokai||'')}</td>
        <td>${esc(e.kisan||'')}</td>
        <td>${esc((e.arrivalDate||'')+' '+(e.arrivalTime||''))}</td>
        <td>${esc((e.departDate||'')+' '+(e.departTime||''))}</td>
        <td>${detail}</td>
        <td class="right">
          <button data-act="view" data-idx="${i}">表示</button>
          <button data-act="mail" data-idx="${i}">メール</button>
          <button data-act="line" data-idx="${i}">LINE</button>
          <button data-act="restore" data-idx="${i}">復元して編集</button>
          <button data-act="del" data-idx="${i}">削除</button>
        </td>
      </tr>`;
    }).join('');
  }

  document.querySelector('#tbl').addEventListener('click',(e)=>{
    const btn = e.target.closest('button'); if (!btn) return;
    const act = btn.dataset.act; const idx = Number(btn.dataset.idx);
    const h = load(); const item = h[idx]; if (!item) return;
    if (act==='view'){ alert(buildText(item)); }
    if (act==='mail'){
      const subject = `【帰参届】${item.kyokai}／${item.kisan}（${item.arrivalDate} 到着）`;
      const body = buildText(item);
      location.href = `mailto:${encodeURIComponent(TO_EMAIL)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    }
    if (act==='line'){
      const text = buildText(item);
      window.open(`https://line.me/R/msg/text/?${encodeURIComponent(text)}`,'_blank');
    }
    if (act==='restore'){
      sessionStorage.setItem(SESSION_KEY, JSON.stringify(item));
      location.href = './index.html';
    }
    if (act==='del'){ h.splice(idx,1); save(h); render(); }
  });

  document.getElementById('exportCsv').addEventListener('click', ()=>{
    const h = load();
    const headers = ['保存時刻','教会名','帰参者名','大人','子供','乳児','到着日','到着時間','発日','発時間','交通種別','交通詳細','直属食券','備考','日別内訳'];
    const rows = h.map(e=>[
      new Date(e.savedAt||Date.now()).toLocaleString('ja-JP',{timeZone:'Asia/Tokyo'}),
      e.kyokai||'', e.kisan||'',
      e.adult||0, e.child||0, e.infant||0,
      e.arrivalDate||'', e.arrivalTime||'',
      e.departDate||'', e.departTime||'',
      e.transport?.type||'', e.transport?.detail||'',
      `${e.ticketDate||''}/${e.ticketCount||0}`,
      e.note||'',
      (e.days||[]).map(r=>`${r.date}:朝${r.breakfast}昼${r.lunch}夜${r.dinner}宿${r.stay}`).join(' / ')
    ]);
    const csv = [headers, ...rows].map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\r\n');
    const blob = new Blob(["\uFEFF"+csv], {type:'text/csv'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'kisan_history.csv'; a.click(); URL.revokeObjectURL(a.href);
  });

  document.getElementById('clearAll').addEventListener('click', ()=>{
    if (confirm('履歴をすべて削除しますか？')){ localStorage.removeItem(HISTORY_KEY); render(); }
  });

  render();
</script>
</body>
</html>
